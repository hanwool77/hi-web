# deployment/container/Dockerfile (entrypoint.sh ë°©ì‹ - ê°€ì¥ ì•ˆì „)
FROM node:18-alpine AS builder

WORKDIR /app

# package.jsonê³¼ package-lock.json ë³µì‚¬
COPY package*.json ./

# ì˜ì¡´ì„± ì„¤ì¹˜ (npm install ì‚¬ìš©)
RUN rm -f package-lock.json && npm install

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ë¹Œë“œ ì‹¤í–‰
RUN npm run build

# Production ë‹¨ê³„
FROM nginx:alpine

# nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
COPY deployment/container/nginx.conf /etc/nginx/nginx.conf

# ë¹Œë“œëœ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/build /usr/share/nginx/html

# entrypoint ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Dockerfile ë‚´ì—ì„œ ì§ì ‘ ìƒì„±)
RUN cat <<'EOF' > /docker-entrypoint.sh
#!/bin/sh
set -e

echo "ğŸš€ Starting HiOrder Frontend..."
echo "ğŸ“‹ Generating runtime-env.js with current environment variables..."

# í™˜ê²½ ë³€ìˆ˜ë¥¼ runtime-env.jsì— ì£¼ì…
cat <<JSEOF > /usr/share/nginx/html/runtime-env.js
window.__runtime_config__ = {
  AUTH_SERVICE_URL: '${AUTH_SERVICE_URL:-http://20.1.2.3/auth}',
  MEMBER_SERVICE_URL: '${MEMBER_SERVICE_URL:-http://20.1.2.3/member}',
  STORE_SERVICE_URL: '${STORE_SERVICE_URL:-http://20.1.2.3/store}', 
  REVIEW_SERVICE_URL: '${REVIEW_SERVICE_URL:-http://20.1.2.3/review}',
  ANALYTICS_SERVICE_URL: '${ANALYTICS_SERVICE_URL:-http://20.1.2.3/analytics}',
  RECOMMEND_SERVICE_URL: '${RECOMMEND_SERVICE_URL:-http://20.1.2.3/recommend}'
};
JSEOF

echo "âœ… runtime-env.js generated successfully"
echo "ğŸ“„ Content:"
cat /usr/share/nginx/html/runtime-env.js

echo "ğŸŒ Starting nginx..."
exec nginx -g 'daemon off;'
EOF

# ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /docker-entrypoint.sh

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 80

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/health || exit 1

# entrypoint ì„¤ì •
ENTRYPOINT ["/docker-entrypoint.sh"]